<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex,nofollow,noarchive">
<link rel="stylesheet" type="text/css" href="../assets/css/bootstrap/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="../assets/css/app.min.css">
</head>

<body class="view view_">
<h1 id="view-title" class="page-header">Archive</h1>
<h2 id="section-title" class="sub-header">{section}</h2>


<div id="section-actions-top" class="section-actions section-actions-top clearfix">
  <div class="pull-left">
    <label for="selection" class="visible-sm-inline-block visible-md-inline-block visible-lg-inline-block">Select Archive</label>
    <select id="selection" onchange="control.action(this, 'selection')"></select>
  </div>
  <div class="pull-right">
    <div class="btn-group">
      <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" onclick="control.action(this, 'export', 'toggler')">Export <span class="caret"></span></button>
      <ul class="dropdown-menu">
        <li><a href="javascript:" onclick="control.action(this, 'export', 'csv'); return false;">Export CSV</a></li>
        <li><a href="javascript:" onclick="control.action(this, 'export', 'clipboard'); return false;">Copy to clipboard</a></li>
      </ul>
    </div>
    <button type="button" class="btn btn-default btn-sm" onclick="control.action(this, 'print')">Print</button>
  </div>
  <div class="clearfix"></div>
  <div>
    <a class="btn btn-gray-light" href="../index.html?archive&add" target="_parent">Create New Archive &raquo;</a>
    <div class="clearfix visible-xs-block visible-sm-block visible-md-block"></div>
    <a class="action btn btn-gray-lighter" href="../index.html?archive&close={id}" onclick="control.action(this, 'close'); return false;" target="_parent">Close Archive</a>
    <a class="action btn btn-secondary" href="../index.html?archive&edit={id}" onclick="control.action(this, 'edit'); return false;" target="_parent">Edit Archive</a>
    <a class="action btn btn-danger" href="../index.html?archive&delete={id}" onclick="control.action(this, 'delete'); return false;" target="_parent">Delete Archive</a>
  </div>
</div>


<form id="form-data" class="form form-data" autocomplete="off" validate>
<div class="table-responsive">
  <table id="table-data" class="table table-data">
    <thead>
      <tr class="hidden-csv">
        <th>Actions</th>
        <th>ID</th>
        <th class="text-nowrap">Name</th>
        <th colspan="4" class="text-center">Popularity</th>
      </tr>
      <tr class="visible-csv hidden">
        <th>ID</th>
        <th>Name</th>
        <th>Movies</th>
        <th>Toyes</th>
        <th>Books</th>
        <th><strong>SUBTOTAL</strong></th>
      </tr>
      <tr class="hidden-csv">
        <td colspan="3"></th>
        <td class="text-center text-nowrap">Movies</td>
        <td class="text-center text-nowrap">Toyes</td>
        <td class="text-center text-nowrap">Books</td>
        <td class="text-center text-nowrap"><strong>SUBTOTAL</strong></td>
      </tr>
    </thead>
    <tbody>
      <tr class="tpl">
        <td class="hidden-print">
          <a class="action btn btn-gray" href="../index.html?archive&open={id}" onclick="control.action(this, 'open'); return false;" target="_parent">Open</a>
        </td>
        <td>{id}</td>
        <td class="text-uppercase text-nowrap">{name}</td>
        <td class="text-center">{pop_movies}</td>
        <td class="text-center">{pop_toyes}</td>
        <td class="text-center">{pop_books}</td>
        <td class="text-center"><strong>{pop_subtotal}</strong></td>
      </tr>
    </tbody>
  </table>
</div>
</form>


<div id="table-wrap-2">
<h4>Review</h4>

<table id="table-2" class="table table-bordered table-auto table-inline">
  <thead>
    <tr>
      <th>Movies</th>
      <th>Toyes</th>
      <th>Books</th>
      <th><strong>SUBTOTAL</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>  
      <td>{archive_pop_movies}</td>
      <td>{archive_pop_toyes}</td>
      <td>{archive_pop_books}</td>
      <td><strong>{archive_pop_subtotal}</strong></td>
    </tr>
  </tbody>
</table>
</div>


<div id="section-actions-bottom" class="section-actions section-actions-bottom">
  <a class="action btn btn-gray-lighter" href="../index.html?archive&close={id}" onclick="control.action(this, 'close'); return false;" target="_parent">Close Archive</a>
  <a class="action btn btn-secondary" href="../index.html?archive&edit={id}" onclick="control.action(this, 'edit'); return false;" target="_parent">Edit Archive</a>
  <a class="action btn btn-danger" href="../index.html?archive&delete={id}" onclick="control.action(this, 'delete'); return false;" target="_parent">Delete Archive</a>
</div>


<style type="text/css">
#table-wrap-2 { margin-bottom: 60px; }
#table-wrap-2 h4 { margin-bottom: 25px; }
#table-wrap-2 h5 { margin-top: 20px; margin-bottom: 10px; }
</style>


<script type="text/javascript" src="../assets/js/app.min.js"></script>
<script type="text/javascript" src="../assets/js/file-saver/FileSaver.min.js"></script>

<script type="text/javascript" src="../config.js"></script>
<script type="text/javascript">
var control = {};

control.openView = function() {
  var archive_id = app.memory.get('archive_id'), category_id = app.memory.get('category_id');
  var data_items = window.store[config.app]['items'];
  var data_archive = window.store[config.app]['archive'];

  if (! data_items || ! data_archive) {
    return app.error(null, [ 'archive', 'control.openView' ]);
  }

  var view_title = document.getElementById('view-title');
  var section_title = document.getElementById('section-title');

  var archive_data = data_archive[archive_id][category_id];
  var archive_items = data_archive[archive_id][category_id].items;

  var archive_selection = {};
  Array.prototype.forEach.call(Object.keys(data_archive), function(id) {
    archive_selection[id] = {};
    archive_selection[id].name = data_archive[id][category_id].title;
    archive_selection[id].selected = (parseInt(id) === archive_id) ? true : false;
  });

  if (! archive_items || ! archive_data || ! archive_selection) {
    return app.error(null, [ 'archive', 'control.openView' ]);
  }

  control.temp = {};
  control.temp.archive_id = archive_id;
  control.temp.category_id = category_id;
  control.temp.archive_data = archive_data;
  control.temp.selection = archive_selection;
  control.temp.archive_select = archive_selection;

  section_title.innerHTML = data_archive[archive_id][category_id].title;

  var select_archive = document.getElementById('selection');
  select_archive.innerHTML = app.view.renderSelect('selection', archive_selection);
  select_archive.value = archive_id;

  var section_actions_top = document.getElementById('section-actions-top');
  section_actions_top.innerHTML = section_actions_top.innerHTML.replace(/\{id\}/g, archive_id);

  var section_actions_bottom = document.getElementById('section-actions-bottom');
  section_actions_bottom.innerHTML = section_actions_bottom.innerHTML.replace(/\{id\}/g, archive_id);


  var t2body = document.querySelector('#table-2 > tbody');
  var t2head = document.querySelector('#table-2 > thead');
  var t2row = t2body.querySelector('tr');

  var archive_subtotals = { 'movies': 0, 'toyes': 0, 'books': 0, 'subtotal': 0 };

  Array.prototype.forEach.call(Object.keys(archive_items), function(id) {
    if (! archive_items[id].pop) {
      archive_items[id].pop = { 'movies': 0, 'toyes': 0, 'books': 0, 'subtotal': 0 };
    }

    archive_items[id].pop.subtotal = archive_items[id].pop['movies'] + archive_items[id].pop['toyes'] + archive_items[id].pop['books']

    archive_subtotals['movies'] += archive_items[id].pop['movies'];
    archive_subtotals['toyes'] += archive_items[id].pop['toyes'];
    archive_subtotals['books'] += archive_items[id].pop['movies'];

    archive_subtotals.subtotal += archive_items[id].pop.subtotal;
  });

  Array.prototype.forEach.call(Object.keys(archive_subtotals), function(key) {
    t2row.innerHTML = t2row.innerHTML.replace('{archive_pop_' + key + '}', archive_subtotals[key]);
  });


  var tbody = document.querySelector('#table-data > tbody');
  var trow_tpl = tbody.querySelector('tr.tpl');

  trow_tpl = trow_tpl.cloneNode(true);
  trow_tpl.classList.remove('tpl');

  var archive_items_keys = Object.keys(archive_items);
  var archive_items_keys_order = [];

  Array.prototype.forEach.call(archive_items_keys, function(id) {
    archive_items_keys_order.push([ id, (archive_items[id].order != undefined ? archive_items[id].order : id) ]);
  });

  var blob = '';

  archive_items_keys_order.sort(function(a, b) { return a[1] - b[1]; });
  archive_items_keys_order = Object.values(archive_items_keys_order);

  archive_items_keys = [];

  Array.prototype.forEach.call(archive_items_keys_order, function(value) {
    archive_items_keys.push(value[0]);
  });

  Array.prototype.forEach.call(archive_items_keys, function(id) {
    var row = control.renderRow(trow_tpl, [ archive_items[id], data_items[id] ]);
    blob += row.outerHTML;
  });

  tbody.innerHTML += blob;

  app.view.resizeView(false);
}

control.renderRow = function(tpl, obj) {
  if (! obj) {
    return app.error(null, [ 'archive', 'control.renderRow' ]);
  }

  var row = tpl.cloneNode(true);

  row.setAttribute('data-index', obj[1].id);

  var status = obj[0] ? true : false;

  row.innerHTML = row.innerHTML
    .replace(/{id}/g, obj[1].id)
    .replace('{name}', obj[1].name)
    .replace('{pop_movies}', obj[0].pop['movies'])
    .replace('{pop_toyes}', obj[0].pop['toyes'])
    .replace('{pop_books}', obj[0].pop['books'])
    .replace('{pop_subtotal}', obj[0].pop['subtotal']);

  return row;
}

control.action = function(element, event) {
  var data_items = window.store[config.app]['items'];
  var data_archive = window.store[config.app]['archive'];

  if (! data_items || ! data_archive || ! control.temp) {
    return app.error(null, [ 'archive', 'control.action' ]);
  }

  if (! element || typeof event !== 'string') {
    return app.error(null, [ 'archive', 'control.action' ]);
  }

  var ctl = false;
  var submitted_data = {};

  var archive_id = control.temp.archive_id;
  var category_id = control.temp.category_id;

  if (event === 'selection') {
    var selection = element.value.toString();
    ctl = { view: 'archive', action: 'selection', submit: true, data: selection };
  }

  if (event === 'open') {
    var trow = element.parentNode.parentNode;
    var id = trow.getAttribute('data-index');
    id = parseInt(id);

    if (id) {
      ctl = { view: 'archive', action: event, index: id };
    }
  }

  if (event === 'edit' || event === 'delete' || event === 'close') {
    var archive_id = parseInt(control.temp.archive_id);
    var archive_title = control.temp.archive_data.titolo

    if (archive_id) {
      ctl = { view: 'archive', action: event, index: archive_id };

      if (event === 'delete') {
        ctl.msg = 'Sei sicuro di voler deletere la stagione "' + archive_title + '" ?\n\n';
        ctl.msg += 'ATTENZIONE! L’OPERAZIONE È IRREVERSIBILE E VERRANNO PERSI TUTTI I DATI INSERITI PER LA STAGIONE';

        submitted_data['archive'] = data_archive;

        delete submitted_data['archive'][archive_id];

        ctl.submit = true;
        ctl.data = JSON.stringify(submitted_data);
      }

      if (event === 'close') {
        ctl.msg = 'Sei sicuro di voler chiudere la stagione "' + archive_title + '" ?';

        submitted_data['archive'] = data_archive;

        submitted_data['archive'][archive_id][category_id].stato = 0;

        ctl.submit = true;
        ctl.data = JSON.stringify(submitted_data);
      }
    }
  }

  if (event === 'export' && arguments.length === 3) {
    var sub_cmd = arguments[2].toString();

    if (! sub_cmd) {
      return;
    }

    var _table = document.querySelector('#table-data');
    var _dropdown = element.parentNode.parentNode.parentNode;

    if (sub_cmd === 'csv') {
      var source = app.view.convertToCSV(_table);
      var filename = 'csv_export';
      var date = new Date();

      filename += '_' + (date.getDate() < 10 ? '0' + date.getDate() : date.getDate()) + '-' + (date.getMonth() < 9 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-' + date.getFullYear();
      filename += '_' + (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + '-' + (date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes());

      var file = new File(
        [ source ],
        filename + '.csv',
        { type: 'text/csv;charset=utf-8' }
      );

      saveAs(file);
    }

    if (sub_cmd === 'clipboard') {
      app.view.copyToClipboard(_table);

      var _dropdown_btn = _dropdown.querySelector('.dropdown-toggle');
      _dropdown_btn.classList.add('btn-gray-lighter');

      setTimeout(function() {
        _dropdown_btn.classList.remove('btn-gray-lighter');
        this.clearTimeout();
      }, 1000);
    }

    if (! ('jQuery' in window && 'dropdown' in jQuery.fn)) {
      if (sub_cmd === 'toggler') {
        app.utils.dropdown('toggle', element, _dropdown)();
      }

      app.utils.addEvent('click', document.body, app.utils.dropdown('close', element, _dropdown));
    }
  }

  if (event === 'print') {
    return window.print();
  }

  if (ctl) {
    ctl = JSON.stringify(ctl);
    window.parent.postMessage(ctl, '*');
    return;
  }
}


window.store = {};

app.load(app.view.load);
app.utils.addEvent('resize', window, app.view.resizeView);
app.utils.addEvent('orientationchange', window, app.view.resizeView);
</script>
</body>
</html>